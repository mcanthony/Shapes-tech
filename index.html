<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Shapes</title>
    <!-- <link rel="stylesheet" href="http://reactifymusic.com/CTRL/default.css" type="text/css" /> -->
    <link type="text/css" rel="stylesheet" href="css/default.css" />
    <script src="http://code.jquery.com/jquery-latest.js"></script>
    <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="./socket.io/socket.io.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <script>
      var clientName;
      var peerName;
      var totalButtonCount = 4;
      var sec = 0;
      var interactionLevel = 0;
      var progressbar
      var incrementUnwrappedSeconds = 1;
      var secondsUnwrapped = 0;

      // var socket = io.connect('10.47.8.81:8081');
      var socket = io.connect('http://localhost:8081');
      socket.on('news', function (data) {
        // console.log(data);
        socket.emit('my other event', { my: 'data' });
      });

      socket.on('log', function (label, data) {
        console.log(label);
        console.log(data);
      });

      // on connection to server, ask for user's name with an anonymous callback
      socket.on('connect', function(){
        // call the server-side function 'adduser' and send one parameter (value of prompt)
        clientName = prompt("What's your name?");
        socket.emit('adduser', clientName);
      });

      socket.on('peerButtonPressed', function(button) {
        $('#btn'+button).css({"backgroundColor": "grey"});
      })

      socket.on('peerButtonReleased', function(button) {
        $('#btn'+button).css({"backgroundColor": origColours[button]});
      })

      socket.on('timeoutButton', function(timeoutButton) {
        // When the button is pressed, unbind it from its press actions, fade it out and fade it back in again slowly
        $('#btn'+timeoutButton).unbind('vmousedown');;
        $('#btn'+timeoutButton).css({"color": "black"});
        $('#btn'+timeoutButton).fadeTo(0, 0, function() {
          $('#btn'+timeoutButton).fadeTo(5000, 1, function() {
            // When the fade back in is complete, rebind it to the button press actions
            console.log('Rebinding');
            $('#btn'+timeoutButton).css({"color": "white"});
            bindButtonToActions('#btn'+timeoutButton);
          });
        });
        console.log('Timing out '+timeoutButton);
      })

      socket.on('assignButtons', function(users) {
        for (var i=0; i < totalButtonCount; i++) {
          var buttonToDisable = "#btn"+i;
          $(buttonToDisable).unbind();

          $(buttonToDisable).css({"opacity": "0.5"});
        }

        for (var i=0; i < users.length; i++) {
          if (users[i].userName == clientName) {
            enableButtons(users[i].assignedButtons);
            labelButtons(users[i].userName, users[i].assignedButtons);
          }else{
            labelButtons(users[i].userName, users[i].assignedButtons);
          }
        }
        // console.log('Users = ' + users[0].userName);
        // enableButtons
      })

      socket.on('updateLevel', function(level, name, timeLimit) {
        interactionLevel = level;
        $('#interactionLevelName').html(name);
        secondsUnwrapped = 0;
        progressbar.attr('value', '0');
        progressbar.attr('max',timeLimit);
        incrementUnwrappedSeconds = 1;
      })

      function labelButtons (name, buttonsToLabel) {
        for (var i=0; i < buttonsToLabel.length; i++) {
          // console.log('Labelling button ' + buttonsToLabel[i] + ' with ' + name);
          var buttonToLabel = "#btn"+buttonsToLabel[i];
          $(buttonToLabel).text(name);
        }
      }

      function enableButtons (enableButtons) {
        for (var i=0; i < enableButtons.length; i++) {
          // console.log('Enabling button ' + enableButtons[i]);
          var buttonToEnable = "#btn"+enableButtons[i];
          $(buttonToEnable).css({"opacity": "1.0"});
          bindButtonToActions(buttonToEnable);
        }
      }

      function bindButtonToActions(buttonToBind) {
        $(buttonToBind).bind('vmousedown', sendButtonReleasedToServer);
        $(buttonToBind).bind('vmouseup', sendButtonPressedToServer); 
      }

      function sendButtonPressedToServer() {
        $(this).css({"backgroundColor": origColours[$(this).attr('buttonIndex')]});
        event.preventDefault();
        socket.emit('buttonReleased', $(this).attr('buttonIndex'));
      }

      function sendButtonReleasedToServer() {
        $(this).css({"backgroundColor": "grey"});
        event.preventDefault();
        socket.emit('buttonPressed', $(this).attr('buttonIndex'));
      }


      var origColours = ['red', 'green', 'blue', 'yellow'];
      var tilt;

      $(document).ready(function() {

        window.addEventListener("devicemotion", function(event) {
          tilt = [  (event.accelerationIncludingGravity.x/10), 
                    (event.accelerationIncludingGravity.y/10),
                    (event.acceleration.z/10)];
        }, true);

        $(".btn").bind('taphold', function(event) {
          event.preventDefault();
        })

        sec = 0;
        function pad ( val ) { return val > 9 ? val : "0" + val; }
        setInterval( function(){
          var secondsWrapped = pad(++sec%60);
          secondsUnwrapped = ++secondsUnwrapped;
          var minutes = pad(parseInt(sec/60,10));
          $("#elapsedTime").html(minutes+":"+secondsWrapped);
          if (incrementUnwrappedSeconds) {
            $("#elapsedSeconds").html(secondsUnwrapped);
            loading();
          }
        }, 1000);

        // Progress bar
        progressbar = $('#progressbar');  
  
        var loading = function() {  
            addValue = progressbar.val(secondsUnwrapped);
            if (secondsUnwrapped == progressbar.attr('max')) { 
              // tell server we've finished this level and request a new one
              console.log('Reached max');
              socket.emit('getNewLevel', clientName, interactionLevel); 
              incrementUnwrappedSeconds = 0;
            }
        };
      });
      window.ondevicemotion = function() {
        if (tilt) {
          socket.emit('didAccelerate', tilt);
        };
      };
    </script>
  </head>
  <body>
    <div id="stats">0 others connected</div>
    <div id="elapsedTime">00:00</div>
    <div id="elapsedSeconds">0</div>
    <div id="interactionLevelName"></div>
    <progress id="progressbar" value="0" max="5"></progress>
    </br>
    <div id="btn0" class="btn" buttonIndex="0">Player 0</div>
    <div id="btn1" class="btn" buttonIndex="1">Player 0</div>
    <div id="btn2" class="btn" buttonIndex="2">Player 0</div>
    <div id="btn3" class="btn" buttonIndex="3">Player 0</div>
  </body>
</html>
